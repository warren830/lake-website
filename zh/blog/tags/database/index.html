<!doctype html>
<html lang="zh" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache DevLake (Incubating) RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache DevLake (Incubating) Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PKZLL38MQG"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-PKZLL38MQG",{anonymize_ip:!0})</script><title data-rh="true">2 篇博文 含有标签「database」 | Apache DevLake (Incubating)</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://devlake.apache.org/zh/blog/tags/database"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" property="og:title" content="2 篇博文 含有标签「database」 | Apache DevLake (Incubating)"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/zh/img/logo.svg"><link data-rh="true" rel="canonical" href="https://devlake.apache.org/zh/blog/tags/database"><link data-rh="true" rel="alternate" href="https://devlake.apache.org/blog/tags/database" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://devlake.apache.org/zh/blog/tags/database" hreflang="zh"><link data-rh="true" rel="alternate" href="https://devlake.apache.org/blog/tags/database" hreflang="x-default"><link rel="stylesheet" href="/zh/assets/css/styles.7f35c1d2.css">
<link rel="preload" href="/zh/assets/js/runtime~main.19ea56ba.js" as="script">
<link rel="preload" href="/zh/assets/js/main.d43e9435.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><div class="navbar__logo"><img src="/zh/img/logo.svg" alt="apache-devlake" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh/img/logo.svg" alt="apache-devlake" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">DevLake</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">文档</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/Overview/Introduction">Latest</a></li><li><a class="dropdown__link" href="/zh/docs/v0.13/Overview/Introduction">v0.13</a></li><li><a class="dropdown__link" href="/zh/docs/v0.12/Overview/Introduction">v0.12</a></li><li><a class="dropdown__link" href="/zh/docs/v0.11/Overview/Introduction">v0.11</a></li></ul></div><a class="navbar__item navbar__link" href="/zh/livedemo/AverageRequirementLeadTime">Live Demo</a><a class="navbar__item navbar__link" href="/zh/community/">社区</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">博客</a><a href="https://github.com/apache/incubator-devlake" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文</a><ul class="dropdown__menu"><li><a href="/blog/tags/database" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/zh/blog/tags/database" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">中文</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/2022/07/15/welcome-open-source">拥抱开源指南</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/compatibility-of-apache-devLake-with-postgreSQL">Compatibility of Apache DevLake with PostgreSQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/refdiff-calculate-commits-diff">refdiff插件的计算提交版本差异算法</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/some-practices-of-supporting-postgresql">Apache DevLake 兼容 PostgreSQL 踩坑小结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/how-DevLake-is-up-and-running">How DevLake is Up and Running</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/apache-devlake-codebase-walkthrough">Apache DevLake代码库导览</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/2022/05/20/如何贡献issues">如何贡献issue</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/apache-welcomes-devlake">DevLake 加入 Apache 孵化器，来和我们一起玩开源！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/how-apache-devlake-runs">Apache DevLake是怎么跑起来的</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/deadlock-caused-by-using-ants">使用ants引发的死锁</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>2 篇博文 含有标签「database」</h1><a href="/zh/blog/tags">查看所有标签</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh/blog/compatibility-of-apache-devLake-with-postgreSQL">Compatibility of Apache DevLake with PostgreSQL</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-06-23T00:00:00.000Z" itemprop="datePublished">2022年6月23日</time> · <!-- -->3 分钟阅读</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/fredtheflat" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/fredtheflat.png" alt="陈舸禹"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/fredtheflat" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">陈舸禹</span></a></div><small class="avatar__subtitle" itemprop="description">Apache DevLake Contributor</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Apache DevLake is a dev data platform that can collect and integrate data from different dev tools including Jira, Github, Gitlab and Jenkins.</p><p>This blog will not aim at a comprehensive summary of the compatibility of database but a record of issues for future reference.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1different--data-types">1.Different  Data Types<a class="hash-link" href="#1different--data-types" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="postgresql-does-not-have-a-uint-type">PostgreSQL does not have a uint type<a class="hash-link" href="#postgresql-does-not-have-a-uint-type" title="标题的直接链接">​</a></h3><div class="language-sql= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type JenkinsBuild struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> common.NoPKModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> JobName           string  `gorm:&quot;primaryKey;type:varchar(255)&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Duration          float64 // build time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> DisplayName       string  // &quot;#7&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> EstimatedDuration float64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Number            int64 `gorm:&quot;primaryKey;type:INT(10) UNSIGNED NOT NULL&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Result            string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Timestamp         int64     // start time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> StartTime         time.Time // convered by timestamp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> CommitSha         string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In <code>JenkinsBuild.Number</code>, the<code>gorm</code>struct tag used <code>UNSIGNED</code>, which will lead to the failure to create table and should be removed.</p><p><img loading="lazy" src="https://i.imgur.com/N7E9Vwd.png" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mysql-does-not-have-a-bool-data-type">MySQL does not have a bool data type<a class="hash-link" href="#mysql-does-not-have-a-bool-data-type" title="标题的直接链接">​</a></h3><p>For a field defined as bool type in model, gorm will map it to MySQL&#x27;s TINYINT data type, which can be queried directly with 0 or 1 in SQL, but PostgreSQL has a bool type, so gorm will map it to the BOOL type. If 0 or 1 is still used in SQL to query, there will be a report of error.</p><p>Here is an example(only relevant fields are shown in the example). The lookup statement works in MySQL, but will lead to an error in PostgreSQL.</p><div class="language-sql= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type GitlabMergeRequestNote struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> MergeRequestId  int    `gorm:&quot;index&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> System          bool </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db.Where(&quot;merge_request_id = ? AND `system` = 0&quot;, gitlabMr.GitlabId).</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After changing the sentence as it follows, an error will still be reported. The reason will be shown in the part about backticks.</p><div class="language-sql= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db.Where(&quot;merge_request_id = ? AND `system` = ?&quot;, gitlabMr.GitlabId, false)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2different-behaviors">2.Different Behaviors<a class="hash-link" href="#2different-behaviors" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bulk-insertion">Bulk insertion<a class="hash-link" href="#bulk-insertion" title="标题的直接链接">​</a></h3><p>When <code>ON CONFLIT UPDATE ALL</code> was used to achieve bulk insertion, and if there are multiple records with the same primary key, it will report errors in PostgreSQL but not in MySQL.
<img loading="lazy" src="https://i.imgur.com/zaExAUG.png" class="img_ev3q"></p><p><img loading="lazy" src="https://i.imgur.com/BpZY8dN.png" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="inconsistent-definition-of-model-with-schema">Inconsistent definition of model with schema<a class="hash-link" href="#inconsistent-definition-of-model-with-schema" title="标题的直接链接">​</a></h3><p>For example, in the model definition, <code>GithubPullRequest.AuthorId</code> is of the int type, but this field in the database is of VARCHAR type. When inserting data, MySQL will accept it, but ProstgresSQL will report an error.</p><div class="language-sql= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type GithubPullRequest struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> GithubId        int    `gorm:&quot;primaryKey&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> RepoId          int    `gorm:&quot;index&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Number          int    `gorm:&quot;index&quot;` </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> State           string `gorm:&quot;type:varchar(255)&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Title           string `gorm:&quot;type:varchar(255)&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> GithubCreatedAt time.Time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> GithubUpdatedAt time.Time `gorm:&quot;index&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ClosedAt        *time.Time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> // In order to get the following fields, we need to collect PRs individually from GitHub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Additions      int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Deletions      int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Comments       int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Commits        int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ReviewComments int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Merged         bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> MergedAt       *time.Time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Body           string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Type           string `gorm:&quot;type:varchar(255)&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Component      string `gorm:&quot;type:varchar(255)&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> MergeCommitSha string `gorm:&quot;type:varchar(40)&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> HeadRef        string `gorm:&quot;type:varchar(255)&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> BaseRef        string `gorm:&quot;type:varchar(255)&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> BaseCommitSha  string `gorm:&quot;type:varchar(255)&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> HeadCommitSha  string `gorm:&quot;type:varchar(255)&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Url            string `gorm:&quot;type:varchar(255)&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> AuthorName     string `gorm:&quot;type:varchar(100)&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> AuthorId       int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> common.NoPKModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://i.imgur.com/onxGG8d.png" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3mysql-specific-functions">3.MySQL-Specific Functions<a class="hash-link" href="#3mysql-specific-functions" title="标题的直接链接">​</a></h2><p>We used the <code>GROUP_CONCAT</code>function in a complex query. Although there are similar functions in PostgreSQL, the function names are different and the usage is slightly different.</p><div class="language-sql= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cursor2, err := db.Table(&quot;pull_requests pr1&quot;).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Joins(&quot;left join pull_requests pr2 on pr1.parent_pr_id = pr2.id&quot;).Group(&quot;pr1.parent_pr_id, pr2.created_date&quot;).Where(&quot;pr1.parent_pr_id != &#x27;&#x27;&quot;).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Joins(&quot;left join repos on pr2.base_repo_id = repos.id&quot;).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Order(&quot;pr2.created_date ASC&quot;).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Select(`pr2.key as parent_pr_key, pr1.parent_pr_id as parent_pr_id, GROUP_CONCAT(pr1.base_ref order by pr1.base_ref ASC) as cherrypick_base_branches, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   GROUP_CONCAT(pr1.key order by pr1.base_ref ASC) as cherrypick_pr_keys, repos.name as repo_name, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   concat(repos.url, &#x27;/pull/&#x27;, pr2.key) as parent_pr_url`).Rows()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Solution:
We finally decided to use two steps to achieve the <code>GROUP_CONCAT</code> function. First we used the simplest SQL query to get multiple pieces of the sorted data, and then used the code to group them.</p><p>After modification:</p><div class="language-sql= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    cursor2, err := db.Raw(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   SELECT pr2.pull_request_key                 AS parent_pr_key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pr1.parent_pr_id                     AS parent_pr_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pr1.base_ref                         AS cherrypick_base_branch,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pr1.pull_request_key                 AS cherrypick_pr_key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          repos.NAME                           AS repo_name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Concat(repos.url, &#x27;/pull/&#x27;, pr2.pull_request_key) AS parent_pr_url,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pr2.created_date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   FROM   pull_requests pr1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          LEFT JOIN pull_requests pr2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ON pr1.parent_pr_id = pr2.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          LEFT JOIN repos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ON pr2.base_repo_id = repos.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   WHERE  pr1.parent_pr_id != &#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ORDER  BY pr1.parent_pr_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             pr2.created_date,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       pr1.base_ref ASC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   `).Rows()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4different-grammar">4.Different Grammar<a class="hash-link" href="#4different-grammar" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="backticks">Backticks<a class="hash-link" href="#backticks" title="标题的直接链接">​</a></h3><p>We used backticks in some SQL statements to protect field names from conflicting with MySQL reserved words, which can lead to errors in PostgreSQL. To solve this problem we revisited our code, modified all field names that conflict with reserved words, and removed the backticks in the SQL statement. In the example just mentioned:</p><div class="language-sql= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db.Where(&quot;merge_request_id = ? AND `system` = ?&quot;, gitlabMr.GitlabId, false)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Solution:
We changed <code>system</code> to <code>is_system</code> to avoid the usage of backticks.</p><div class="language-sql= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db.Where(&quot;merge_request_id = ? AND is_system = ?&quot;, gitlabMr.GitlabId, false)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="non-standard-delete-statement">Non-standard delete statement<a class="hash-link" href="#non-standard-delete-statement" title="标题的直接链接">​</a></h3><p>There were delete statements as followed in our code, which are legal in MySQL but will report an error in PostgreSQL.</p><div class="language-sql= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql= codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">err := db.Exec(`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> DELETE ic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> FROM jira_issue_commits ic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> LEFT JOIN jira_board_issues bi ON (bi.source_id = ic.source_id AND bi.issue_id = ic.issue_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> WHERE ic.source_id = ? AND bi.board_id = ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> `, sourceId, boardId).Error</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/devlake">devlake</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/database">database</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/postgresql">postgresql</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh/blog/some-practices-of-supporting-postgresql">Apache DevLake 兼容 PostgreSQL 踩坑小结</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-06-17T00:00:00.000Z" itemprop="datePublished">2022年6月17日</time> · <!-- -->4 分钟阅读</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/mindlesscloud" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/8455907?s=400&amp;v=4" alt="ZhangLiang"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/mindlesscloud" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">ZhangLiang</span></a></div><small class="avatar__subtitle" itemprop="description">Apache DevLake PPMC</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>本文作者：ZhangLiang<br>
<!-- -->个人主页：<a href="https://github.com/mindlesscloud" target="_blank" rel="noopener noreferrer">https://github.com/mindlesscloud</a></p><p>Apache DevLake 是一个研发数据平台，可以收集和整合各类研发工具的数据，比如 Jira、Github、Gitlab、Jenkins。</p><p><strong>本文并不打算对数据库兼容这个问题做全面的总结，只是对我们实际遇到的问题做一个记录，希望能对有相似需求的人提供一个参考。</strong></p><p><strong>1、数据类型差异</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="postgresql-不支持-uint-类型的数据类型">PostgreSQL 不支持 uint 类型的数据类型<a class="hash-link" href="#postgresql-不支持-uint-类型的数据类型" title="标题的直接链接">​</a></h3><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> JenkinsBuild </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoPKModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    JobName           </span><span class="token builtin">string</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">`gorm:&quot;primaryKey;type:varchar(255)&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Duration          </span><span class="token builtin">float64</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// build time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DisplayName       </span><span class="token builtin">string</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// &quot;#7&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EstimatedDuration </span><span class="token builtin">float64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Number            </span><span class="token builtin">int64</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:&quot;primaryKey;type:INT(10) UNSIGNED NOT NULL&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Result            </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Timestamp         </span><span class="token builtin">int64</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// start time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StartTime         time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time </span><span class="token comment" style="color:#999988;font-style:italic">// convered by timestamp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CommitSha         </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中的<code>JenkinsBuild.Number</code>字段的<code>gorm</code> struct tag 使用了<code>UNSIGNED</code>会导致建表失败，需要去掉。</p><p><img loading="lazy" src="/zh/assets/images/df2f9837-121e-4a64-976c-c5039d452bfd-f129f63a0aad6218d9040f3eb2917990.png" width="3730" height="236" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mysql-没有-bool-型">MySQL 没有 bool 型<a class="hash-link" href="#mysql-没有-bool-型" title="标题的直接链接">​</a></h3><p>对于 model 里定义为 bool 型的字段，gorm 会把它映射成 MySQL 的 TINYINT 类型，在 SQL 里可以直接用 0 或者 1 查询，但是 PostgreSQL 里是有 bool 类型的，所以 gorm 会把它映射成 BOOL 类型，如果 SQL 里还是用的 0 或者 1 去查询就会报错。</p><p>以下是一个具体的例子（为了清晰起见我们删掉了无关的字段），下面的查询语句在 MySQL 里是没有问题的，但是在  PostgreSQL 上就会报错。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> GitlabMergeRequestNote </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MergeRequestId  </span><span class="token builtin">int</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">`gorm:&quot;index&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System          </span><span class="token builtin">bool</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;merge_request_id = ? AND `system` = 0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gitlabMr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GitlabId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>语句改成这样后仍然会有错误，具体请见下面关于反引号的问题。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;merge_request_id = ? AND `system` = ?&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gitlabMr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GitlabId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2、行为差异</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="批量插入">批量插入<a class="hash-link" href="#批量插入" title="标题的直接链接">​</a></h3><p>如果使用了<code>ON CONFLIT UPDATE ALL</code>从句批量插入的时候，本批次如果有多条主键相同的记录会导致 PostgreSQL 报错，MySQL 则不会。</p><p><img loading="lazy" src="/zh/assets/images/efea0188-80e4-4519-a010-977a7fd5432e-24bf2c80d325f021cfb13cd26652aec9.png" width="3718" height="634" class="img_ev3q"></p><p><img loading="lazy" src="/zh/assets/images/7b2a6f29-ea2a-4a84-97c8-7eba5a5131a8-ecef21ecd88f5e7e73b4ba15818892d4.png" width="3712" height="184" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="字段类型-model-定义与-schema-不一致">字段类型 model 定义与 schema 不一致<a class="hash-link" href="#字段类型-model-定义与-schema-不一致" title="标题的直接链接">​</a></h3><p>例如在 model 定义中<code>GithubPullRequest.AuthorId</code>是 int 类型，但是数据库里这个字段是 VARCHAR 类型，插入数据的时候 MySQL 是允许的，PostgreSQL 则会报错。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> GithubPullRequest </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GithubId        </span><span class="token builtin">int</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">`gorm:&quot;primaryKey&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RepoId          </span><span class="token builtin">int</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">`gorm:&quot;index&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Number          </span><span class="token builtin">int</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">`gorm:&quot;index&quot;`</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    State           </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:&quot;type:varchar(255)&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Title           </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:&quot;type:varchar(255)&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GithubCreatedAt time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GithubUpdatedAt time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time </span><span class="token string" style="color:#e3116c">`gorm:&quot;index&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClosedAt        </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// In order to get the following fields, we need to collect PRs individually from GitHub</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Additions      </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Deletions      </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Comments       </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Commits        </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReviewComments </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Merged         </span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MergedAt       </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Body           </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type           </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:&quot;type:varchar(255)&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Component      </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:&quot;type:varchar(255)&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MergeCommitSha </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:&quot;type:varchar(40)&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HeadRef        </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:&quot;type:varchar(255)&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BaseRef        </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:&quot;type:varchar(255)&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BaseCommitSha  </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:&quot;type:varchar(255)&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HeadCommitSha  </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:&quot;type:varchar(255)&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Url            </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:&quot;type:varchar(255)&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthorName     </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`gorm:&quot;type:varchar(100)&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthorId       </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoPKModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="/zh/assets/images/8afb097c-a0b3-4bdc-80f3-7241c3fa566f-05d6a3d073455a2d728f33dedce09593.png" width="3718" height="224" class="img_ev3q"></p><p><strong>3、MySQL 特有的函数</strong></p><p>在一个复杂查询中我们曾经使用了 <code>GROUP_CONCAT</code> 函数，虽然 PostgreSQL 中有功能类似的函数但是函数名不同，使用方式也有细微差别。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cursor2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Table</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;pull_requests pr1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Joins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;left join pull_requests pr2 on pr1.parent_pr_id = pr2.id&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Group</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;pr1.parent_pr_id, pr2.created_date&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;pr1.parent_pr_id != &#x27;&#x27;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Joins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;left join repos on pr2.base_repo_id = repos.id&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Order</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;pr2.created_date ASC&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">`pr2.key as parent_pr_key, pr1.parent_pr_id as parent_pr_id, GROUP_CONCAT(pr1.base_ref order by pr1.base_ref ASC) as cherrypick_base_branches, </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            GROUP_CONCAT(pr1.key order by pr1.base_ref ASC) as cherrypick_pr_keys, repos.name as repo_name, </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            concat(repos.url, &#x27;/pull/&#x27;, pr2.key) as parent_pr_url`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Rows</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>解决方案：
我们最终决定把<code>GROUP_CONCAT</code>函数的功能拆分成两步，先用最简单的 SQL 查询得到排序好的多条数据，然后用代码做聚合。</p><p>修改后：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cursor2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Raw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">`</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            SELECT pr2.pull_request_key                 AS parent_pr_key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   pr1.parent_pr_id                     AS parent_pr_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   pr1.base_ref                         AS cherrypick_base_branch,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   pr1.pull_request_key                 AS cherrypick_pr_key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   repos.NAME                           AS repo_name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   Concat(repos.url, &#x27;/pull/&#x27;, pr2.pull_request_key) AS parent_pr_url,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   pr2.created_date</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            FROM   pull_requests pr1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   LEFT JOIN pull_requests pr2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                          ON pr1.parent_pr_id = pr2.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                   LEFT JOIN repos</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                          ON pr2.base_repo_id = repos.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            WHERE  pr1.parent_pr_id != &#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            ORDER  BY pr1.parent_pr_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                      pr2.created_date,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                      pr1.base_ref ASC</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            `</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Rows</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4、语法差异</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="反引号">反引号<a class="hash-link" href="#反引号" title="标题的直接链接">​</a></h3><p>某些 SQL 语句中我们使用了反引号，用来保护字段名，以免跟 MySQL 保留字有冲突，这种做法在 PostgreSQL 会导致语法错误。为了解决这个问题我们重新审视了我们的代码，把所有跟保留字冲突的字段名做了修改，同时去掉了 SQL 语句中的反引号。例如刚才提到的这个例子：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;merge_request_id = ? AND `system` = ?&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gitlabMr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GitlabId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>解决方案：我们把<code>system</code>改个名字<code>is_system</code>，这样就可以把反引号去掉。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;merge_request_id = ? AND is_system = ?&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gitlabMr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GitlabId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="不规范的删除语句">不规范的删除语句<a class="hash-link" href="#不规范的删除语句" title="标题的直接链接">​</a></h3><p>我们的代码中曾经出现过这种删除语句，这在 MySQL 中是合法的，但是在 PostgreSQL 中会报语法错误。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Exec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">`</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    DELETE ic</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    FROM jira_issue_commits ic</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    LEFT JOIN jira_board_issues bi ON (bi.source_id = ic.source_id AND bi.issue_id = ic.issue_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    WHERE ic.source_id = ? AND bi.board_id = ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    `</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> boardId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>解决方案：我们把<code>DELETE</code>后面的表别名去掉就可以了。</p><p><strong>了解更多最新动态</strong></p><p>官网：<a href="https://devlake.incubator.apache.org/" target="_blank" rel="noopener noreferrer">https://devlake.incubator.apache.org/</a></p><p>GitHub：<a href="https://github.com/apache/incubator-devlake/" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-devlake/</a></p><p>Slack：通过 <a href="https://devlake-io.slack.com/join/shared_invite/zt-18uayb6ut-cHOjiYcBwERQ8VVPZ9cQQw#/shared-invite/email" target="_blank" rel="noopener noreferrer">Slack</a> 联系我们</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/devlake">devlake</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/database">database</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/postgresql">postgresql</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/GettingStarted">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/DataModels/DevLakeDomainLayerSchema">Data Models</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/Metrics">Engineering Metrics</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/devlake-io/shared_invite/zt-17b6vuvps-x98pqseoUagM7EAmKC82xQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-devlake/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Issue Tracker</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/apache/incubator-devlake" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 DevLake@Merico Inc.</div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.19ea56ba.js"></script>
<script src="/zh/assets/js/main.d43e9435.js"></script>
</body>
</html>